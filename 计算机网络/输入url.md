# 输入一段URL

​	第一步，生成HTTP消息。

## 生成HTTP消息

​	输入一段url后，进行解析。获取其中的协议，（http）web服务器域名和端口、文件路径名。解析是为了清楚访问的目标。清楚了目标还需要明确进行怎样的操作。

http协议有多种方法，定义了对资源的不同操作。

1. GET：获取 URI 指定的信息。如果 URI 指定的是文件，则 返回文件的内容；如果 URI 指定的是 CGI 程序，则 返回该程序的输出数据
2. POST：客户端向服务器发送数据。一般用于发送表单中 填写的数据等情况下
3. HEAD：和GET基本相同。只返回HTTP消息头，并不返回数据的内容。
4. OPTIONS：？
5. PUT：替换URI指定的服务器上的文件。
6. DELETE：删除URI指定的服务器上的文件。

## 获取web服务器的IP地址

​	浏览器能够解析网址并生成HTTP消息但是不能讲消息发送到网络中。需要委托操作系统来实现。想要发送消息就需要服务器的IP地址，可以通过浏览器获取的服务器的域名来获取对应的IP地址。即通过DNS来获取。

​	查询IP通过计算机的DNS客户端（解析器）向DNS服务器发出查询。解析器实际上是一段程序，它包含在操作系统的 Socket 库中。浏览器调用解析器时， 程序的控制流程就会转移到解析器的内部。当控制流程转移到解析器后，解析器会生成要发送给 DNS 服务器的查 询消息。这个过程与浏览器生成要发送给 Web 服务器的 HTTP 请求消息的 过程类似，解析器会根据 DNS 的规格，生成代表获取目标IP地址的一条数据，并将它发送给DNS服务器。发送消息需要委托操作系统的协议栈来执行（操作系统内部的网络控制软件，也叫“协议驱动”“TCP/IP 驱动”等）。当DNS服务器收到查询消息后，会根据消息中的查询内容进行查询。响应消息中包含查询到的IP地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。

## DNS服务器的基本工作

来自客户端的查询消息包含3种。

​	1.域名

​	2.Class：识别网络。值永远是代表互联网的IN。

​	3.记录类型：表示域名对应的何种类型的记录。如：类型为A时，表示域名对应的IP。类型为MX时，表示对应的是邮件服务器。

查询时，DNS服务器会先从已有的记录中查找域名、Class和记录类型全部匹配的记录，匹配上则返回IP。

![DNS查询](https://daytime-1303889004.cos.ap-nanjing.myqcloud.com/001.png)

​	寻找相应的DNS服务器获取IP地址。首先，将负责管理下级域的 DNS 服务器的 IP 地址注 册到它们的上级 DNS 服务器中，然后上级 DNS 服务器的 IP 地址再注册到 更上一级的 DNS 服务器中，以此类推。将根域的 DNS 服务器信息保 存在互联网中所有的 DNS 服务器中。这样一来，任何 DNS 服务器就都可 以找到并访问根域 DNS 服务器了。因此，客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜 找到位于下层的某台目标 DNS 服务器。分配给根域 DNS 服务器 的 IP 地址在全世界仅有 13 个 A，而且这些地址几乎不发生变化，因此将这 些地址保存在所有的 DNS 服务器中也并不是一件难事。实际上，根域 DNS 服务器的相关信息已经包含在 DNS 服务器程序的配置文件中了，因 此只要安装了 DNS 服务器程序，这些信息也就被自动配置好了。

### 委托协议栈发送HTTP消息 

​	收发数据就是在两台计算机之间连接一条数据通道，数据沿着这条通道流动，最终到达目的。不过，不代表现实真的有这么一条管道，只是为了理解。

​	首先，需要双方先建立起这条管道。需要先创建套接字然后将套接字连接起来形成管道。由服务器一方先创建套接字，然后等待客户端向该套接字连接管道。客户端会创建一个套接字，然后从该套接字延伸出管道，最后管道连接到服务端的套接字上。当服务器进入等待状态时，客户端就可以连接管道了。等双方的套接字连接起来之后，通信准备就完成了。我们将数据送入套接字就可以收发数据。当数据全部发送完毕之后，连接的管道将会断开。管道在连接时是由客户端发起的，但在断开时可以由客户端或服务器任意一方发起。其中一方断开后，另一方也会随之断开，当管道断开后，套接字会被删除。

​	在每个阶段，Socket 库中的程序组件都会被调用来执行相关的数据收 发操作。

### 创建套接字阶段

​	调用Socket库中的socket组件，创建套接字。套接字创建完成后，协议栈会返回一个描述符，应用程序会将收到的描述符存放在内存中。描述符是用来识别不同套接字的。

![image](https://daytime-1303889004.cos.ap-nanjing.myqcloud.com/002.png)

### 连接阶段

​	应用程序通过调用 Socket 库中的名为 connect 的程序组件来完成这一操作。当调用 connect 时，需要指定描述符、 服务器 IP 地址和端口号（服务端的）这 3 个参数。

​	描述符和端口号都是识别套接字的，那为什么需要端口号呢？

​	因为描述符是用来和委托创建套接字的应用程序交互使用的，并不是用来告诉网络连接的另一方的，因此另一方不知道这个描述符。同样客户端也无法知道服务器上的描述符。因而需要一个适用的机制，这个机制就是端口号。

​	可以用端口号来识别套接字，那为什么还需要描述符呢？----------> 待续

​	服务器也需要知道客户端的套接字号码完成连接。客户端会在创建套接字时，协议栈会为这个套接字随便分配一个端口号，当协议栈执行连接操作时，会将这个随机分配的端口号通知服务器。

### 通信阶段

​	应用程序需要在内存中准备好要发送的数据，根据用户输入的网址生成的HTTP请求消息就是我们要发送的数据。应用程序调用Socket库的write程序组件，指定描述符和发送数据，然后协议栈会将数据发送到服务器。由于套接字中已经保存了已连接的通信对象的相关信息，所以 只要通过描述符指定套接字，就可以识别出通信对象，并向其发送数据。

​	当消息返回后，需要执行的是接收消息的操作。接收消息的操作是通 过 Socket 库中的 read 程序组件委托协议栈来完成的。调用 read 时需要指定用于存放接收到的响应消息的内存地址，这一内存地址称 为接收缓冲区。于是，当服务器返回响应消息时，read 就会负责将接收到 的响应消息存放到接收缓冲区中。

### 断开阶段

​	当浏览器收到数据之后，收发数据的过程就结束了。Web 使用的 HTTP 协议规定，当 Web 服务器发送完 响应消息之后，应该主动执行断开操作。Web 服务器会首先调用 close 来断开连接。断开操作传达到客户端之后，客户端的套接字也会进入 断开阶段。接下来，当浏览器调用 read 执行接收数据操作时，read 会告知 浏览器收发数据操作已结束，连接已经断开。浏览器得知后，也会调用 close 进入断开阶段。